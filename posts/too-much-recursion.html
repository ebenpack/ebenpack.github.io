<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>Too Much Recursion! — Eben Packwood</title>
    <!--[if lte IE 8]><script type="text/javascript" src="http://www.ebenpackwood.com/theme/js/html5shiv.js"></script><![endif]-->
    <link rel="canonical" href="http://www.ebenpackwood.com/posts/too-much-recursion.html" >
    <link rel="stylesheet" type="text/css" href="http://www.ebenpackwood.com/theme/css/style.min.css?f9767b9f" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="http://www.ebenpackwood.com/favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="Eben Packwood — Flux Atom"
                           href="http://www.ebenpackwood.com/" /> 

    <meta name="author"   content="ebenpack" />
    <meta name="keywords" content="JavaScript" />
    <link rel="stylesheet" media="not print" type="text/css" href="http://www.ebenpackwood.com/theme/css/pygments.css" />
    <meta name="description" content="In which the author addresses the claim, made in the new O'Reilly book 'Data Structures and Algorithms in JavaScript', that 'it is not possible to [implement Mergesort as a recursive algorithm] in JavaScript, as the recursion goes too deep for the language to handle'." />
  </head>
  <body>
    <div id="page" class="page">   
      <div id="page-body" class="page-body">
        <article class="post page-main" id="page-main" role="main">
      <header class="post-header">
        <h1>
          <a rel="bookmark"
             href="http://www.ebenpackwood.com/posts/too-much-recursion.html"
             title="Permanent link Too Much Recursion!">
             Too Much Recursion!
          </a>
        </h1>
        <div class="meta">
<!-- includes/article_meta.html -->
            Posted <time datetime="2014-07-30T21:00:00">Wed 30 July 2014</time>
            in <a href="http://www.ebenpackwood.com/category/javascript.html">JavaScript</a> 
            by <a href="http://www.ebenpackwood.com/author/ebenpack.html">ebenpack</a>              <br />Tags:              <a rel="tag" href="http://www.ebenpackwood.com/tag/javascript.html">JavaScript</a>        </div>
      </header>
      <div class="post-content"> 
        <p>I was reading 'Data Structures and Algorithms in JavaScript' by Michael McMillan the other day. While the book as a whole is absolutely riddled with errors, this passage struck me as being particularly egregious.</p>
<blockquote>
<p>It is customary, though not necessary, to implement Mergesort as a recursive algorithm. However, <strong>it is not possible to do so in JavaScript, as the recursion goes too deep for the language to handle</strong>. [emphasis mine]</p>
</blockquote>
<p>It is not possible to implement recursive mergesort in JavaScript! Because the recursion goes too deep! What utter nonsense.</p>
<p>To see why this is such a patently absurd claim, we must first establish a few facts. First, what is the stack depth for JavaScript? This isn't something that is defined by the specification, so it's going to be implementation dependent. User josh3736 reported the stack depths of several browsers in his StackOverflow answer <a href="http://stackoverflow.com/questions/7826992/browser-javascript-stack-size-limit#7828803">here</a>. A quick check of the browsers easily available to hand suggests his assessment to be more or less in the right neighborhood. At worst, we have a stack depth of ~1,000 (insert IE6 joke here), and at best it could be as high as ~65,000. The mean seems to be somewhere around ~20,000-30,000.</p>
<p>The next fact we need to establish is how large can a JavaScript array be? This is a lot more straightforward than the stack depth. The ECMA standard clearly defines the maximum length of an array to be 2<sup>32</sup>-1, or 4,294,967,295. Which is just a hair north of 4 billion. That's a very large array.</p>
<p>So, now that we've sorted out our facts, why is McMillan's claim so absurd? To understand that, we need to take a closer look at mergesort. Mergesort is a textbook divide-and-conquer algorithm. It works by splitting an array in half, then calling mergesort recursively on each half until it reaches the base case. Then it merges each half back together such that the result is sorted. For any given array of sufficient size, mergesort will be called twice, once on the lower half, and once on the upper half. For each of those halves, mergesort will then potentially be called twice again, and so on.</p>
<p>It should be evident that the number of times an array can be divided in this fashion will be log<sub>2</sub>(n). Not coincidentally, this is the maximum recursive depth mergesort will reach. Put another way, mergesort will reach a recursive depth of n when called on an array of length 2<sup>n</sup>. It follows from this that, given our maximum array length, the maximum recursive depth that mergesort can possibly reach is 32 calls deep (maybe 33 if you count the original call). This is nowhere close to reaching even the shallowest possible stack depth.</p>
<p>I quickly knocked up a recursive mergesort implementation (which I am including below) and set it to work sorting ever larger arrays. My implementation (which I'm sure leaves much room for improvement) crapped out after trying to sort an array of 2<sup>25</sup> items. Not because of what Firefox rather endearingly refers to as "too much recursion", but rather because it takes a heck of a lot of work to sort an array with tens of millions of items. Heck, forget sorting, Chrome wouldn't even let me push more than 2<sup>26</sup> items into an array. So, while it's true that mergesort in JavaScript might have some trouble with arrays of 2<sup>25</sup> items, this has nought to do with the depth of recursion or the call stack. I'll repeat that: any problems mergesort might have with very large arrays are wholly unrelated to the depth of recursion or the call stack, and any claims otherwise suggest a fundamental misunderstanding of either how the algorithm works, the basic fundamentals of JavaScript, or both.</p>
<p>Just as a thought experiment, though, how large would an array actually need to be to reach or exceed the stack depth of, say, IE6? If you recall, IE6 has a stack depth of ~1,000. Let's just call it 1,000 even. As we demonstrated, in order to reach this recursive depth with mergesort, the array would have to have a length of 2<sup>1,000</sup>. In base-10 this is ~10<sup>301</sup>. This translates to a one followed by 301 other numbers. It looks exactly like this:</p>
<div class="highlight"><pre><span class="mi">10715086071862673209484250490600018105614048117055336074437503883703510511249361224931983788156958581275946729175531468251871452856923140435984577574698574803934567774824230985421074605062371141877954182153046474983581941267398767559165543946077062914571196477686542167660429831652624386837205668069376</span>
</pre></div>


<p>It's a pretty big number. To give an idea of the scale of this number, it's greater than the number of atoms in the observable universe, which, in case you were wondering, there are approx. 10<sup>80</sup> of, give or take a few orders of magnitude. So to be a bit technical for a moment, it's actually much, much, much greater than the number of atoms in the universe. In fact, any description I could attempt to give w/r/t just how much greater than the number of atoms in the universe this number really is, would just be such a colossal understatement that it would only be an affront to large numbers, and indeed to the very concept of largeness in general. Just believe me when I say that it's wowie big.</p>
<p>The point is, there's a good chance you're not going to be reaching the maximum call stack depth with mergesort, even if you really, really believe your array is well above average size. I would actually go so far as to say it is completely impossible to exceed the stack depth with mergesort in JavaScript, assuming you're sorting a standard JavaScript array and you're using a well implemented mergesort function. So there's a good chance that anyone who claims that</p>
<blockquote>
<p>It is not possible to [implement Mergesort as a recursive algorithm] in JavaScript, as the recursion goes too deep for the language to handle.</p>
</blockquote>
<p>might not know what they're talking about. Like, at all.</p>
<p>While this certainly is one of the more flagrant errors in the book, it is just one of many. If you're on the fence about getting this book, I would recommend you give it a pass.</p>
<p>Anyway, here's some code:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// The number of stack traces that will be logged in the console.</span>
<span class="c1">// We call console.log() when we reach the base case in our</span>
<span class="c1">// mergesort function, which will be the maximum recursive depth.</span>
<span class="c1">// We&#39;re only going to call this the first few times, as</span>
<span class="c1">// it can really bog things down otherwise.</span>
<span class="kd">var</span> <span class="nx">stacktraces</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// The array we will be sorting.</span>
<span class="kd">var</span> <span class="nx">big_array</span> <span class="o">=</span> <span class="p">[];</span>

<span class="c1">// Build our array with numbers going in descending order.</span>
<span class="c1">// The array size, max, can be larger, but things slow down </span>
<span class="c1">// and start to get wonky at about 2^25.</span>
<span class="kd">var</span> <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
    <span class="nx">big_array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">big_array</span> <span class="o">=</span> <span class="nx">mergesort</span><span class="p">(</span><span class="nx">big_array</span><span class="p">);</span>

<span class="c1">// Standard merge</span>
<span class="kd">function</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">alen</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">blen</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">alen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">blen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">alen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">blen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
                <span class="nx">alen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
                <span class="nx">blen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">alen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
            <span class="nx">alen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">blen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
            <span class="nx">blen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Standard recursive mergesort</span>
<span class="kd">function</span> <span class="nx">mergesort</span><span class="p">(</span><span class="nx">lst</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">lst</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stacktraces</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">){</span>
            <span class="c1">// This will print a call stack to the console the</span>
            <span class="c1">// first ten times our mergesort reaches the base case.</span>
            <span class="c1">// It should be clear that the maximum recursive depth</span>
            <span class="c1">// of our mergesort function is n+1, where our array</span>
            <span class="c1">// has on the order of 2^n items.</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
            <span class="nx">stacktraces</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">lst</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">length</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">mergesort</span><span class="p">(</span><span class="nx">lst</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">q</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">mergesort</span><span class="p">(</span><span class="nx">lst</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">q</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Addendum: I was curious about the relative performance of the iterative and recursive mergesort implementations. As you can see, the iterative approach is much faster, and I believe it uses quite a bit less memory as well.</p>
<div id="graph">
    <style scoped>
        path {
            stroke-width: 3;
            fill: none;
        }

        .iter{
            stroke: steelblue;
        }

        .recurse{
            stroke: rgb(223, 94, 98);
        }

        .axis {
          shape-rendering: crispEdges;
        }

        .x.axis line {
          stroke: lightgrey;
        }

        .x.axis .minor {
          stroke-opacity: .5;
        }

        .x.axis path {
          display: none;
        }

        .y.axis line, .y.axis path {
          fill: none;
          stroke: #000;
        }
    </style>
    <svg viewBox="0 0 1000 400">
        <g transform="translate(80,80)">
            <g class="x axis" transform="translate(0,240)">
                <g class="tick" transform="translate(0,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2⁹</text>
                </g>
                <g class="tick" transform="translate(120,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2¹⁰</text>
                </g>
                <g class="tick" transform="translate(240,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2¹¹</text>
                </g>
                <g class="tick" transform="translate(360,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2¹²</text>
                </g>
                <g class="tick" transform="translate(480,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2¹³</text>
                </g>
                <g class="tick" transform="translate(599.9999999999999,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2¹⁴</text>
                </g>
                <g class="tick" transform="translate(720,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2¹⁵</text>
                </g>
                <g class="tick" transform="translate(840,0)">
                    <line y2="-240" x2="0"></line>
                    <text y="10" x="0" dy=".71em" style="text-anchor: middle;">2¹⁶</text>
                </g>
                <path class="domain" d="M0,-240V0H840V-240"></path>
            </g>
            <text class="y label" text-anchor="end" y="6" dy=".75em" transform="rotate(-90)">execution time (milliseconds)</text>
            <text class="x label" text-anchor="end" x="200" y="280" dx=".75em">array length</text>
            <rect x="140" y="55" width="10" height="10" style="fill: steelblue;"></rect>
            <rect x="140" y="25" width="10" height="10" style="fill: rgb(223, 94, 98);"></rect>
            <text text-anchor="start" x="160" y="65">Iterative</text>
            <text text-anchor="start" x="160" y="35">Recursive</text>
            <g class="y axis" transform="translate(-25,0)">
                <g class="tick" transform="translate(0,240)">
                    <line x2="-6" y2="0"></line>
                    <text x="-9" y="0" dy=".32em" style="text-anchor: end;">0</text>
                </g>
                <g class="tick" transform="translate(0,188.4978540772532)">
                    <line x2="-6" y2="0"></line>
                    <text x="-9" y="0" dy=".32em" style="text-anchor: end;">100</text>
                </g>
                <g class="tick" transform="translate(0,136.99570815450642)">
                    <line x2="-6" y2="0"></line>
                    <text x="-9" y="0" dy=".32em" style="text-anchor: end;">200</text>
                </g>
                <g class="tick" transform="translate(0,85.49356223175965)">
                    <line x2="-6" y2="0"></line>
                    <text x="-9" y="0" dy=".32em" style="text-anchor: end;">300</text>
                </g>
                <g class="tick" transform="translate(0,33.99141630901286)">
                    <line x2="-6" y2="0"></line>
                    <text x="-9" y="0" dy=".32em" style="text-anchor: end;">400</text>
                </g>
                <path class="domain" d="M-6,0H0V240H-6"></path>
            </g>
            <path class="iter" d="M0,240L0,240L0,240L0,240L0,240L0,240L0,240L0,240L0,240L0,239.48497854077254L120,238.96995708154506L240,236.90987124463518L360,233.8197424892704L480,228.6695278969957L599.9999999999999,215.27896995708156L720,195.1931330472103L840,146.78111587982832"></path>
            <path class="recurse" d="M0,240L0,240L0,240L0,240L0,240L0,239.48497854077254L0,240L0,240L0,239.48497854077254L0,238.4549356223176L120,237.42489270386267L240,233.3047210300429L360,225.57939914163092L480,214.24892703862662L599.9999999999999,185.40772532188842L720,121.54506437768241L840,0"></path>
        </g>
    </svg>
</div>
      </div>
      <footer class="post-footer">
        <div class="meta">
            Posted in <a href="http://www.ebenpackwood.com/category/javascript.html">JavaScript</a> 
            by <a href="http://www.ebenpackwood.com/author/ebenpack.html">ebenpack</a><br />
            Tags:  #<a href="http://www.ebenpackwood.com/tag/javascript.html">JavaScript</a>        </div>
      </footer>
      </article> <!-- /#page-main -->

        <aside id="page-side" class="page-side">
          <!-- begin includes/sidebar.html -->
          <h2>
            <a href="http://www.ebenpackwood.com/index.html">Eben Packwood</a>
          </h2>
          <nav>
            <h3>Pages</h3>
            <ul>
              <li><a href="http://www.ebenpackwood.com">Home</a></li>
              <li><a href="http://www.ebenpackwood.com/categories.html">Categories</a></li>
              <li ><a href="http://www.ebenpackwood.com/archives.html">Archives</a></li>
              <li><a href="http://www.ebenpackwood.com/tags.html">Tags</a></li>
              <li><a href="http://www.ebenpackwood.com/pages/projects.html">Projects</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Categories</h3>
            <ul>
              <li><a href="http://www.ebenpackwood.com/category/css.html">CSS</a></li>
              <li class="active"><a href="http://www.ebenpackwood.com/category/javascript.html">JavaScript</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Social</h3>
            <ul>
              <li><a href="https://github.com/ebenpack" target="_blank">GitHub</a></li>
            </ul>
          </nav>
          <!-- end includes/sidebar.html --></aside> <!-- /#page-side -->
      </div>  <!-- /#page-body -->

      <footer id="page-foot" class="page-foot">
        <p> Powered by <a href="http://pelican.readthedocs.org">Pelican</a></p>
<p><a id="github-link" class="github-link" href="https://github.com/ebenpack/ebenpack.github.io">Fork me on Github</a></p><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.
      </footer>
    </div> <!-- /#page -->
    <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="http://www.ebenpackwood.com/theme/js/jquery-1.11.0.min.js"><\/script>')</script> -->
    <!-- <script src="http://www.ebenpackwood.com/theme/js/main.js"></script> -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48710000-1', 'ebenpackwood.com');
    ga('send', 'pageview');

    </script>
  </body>
</html>